<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - JobHive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
            padding-top: 20px;
        }
        .sidebar .nav-link {
            color: white;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
        }
        .sidebar .nav-link.active {
            background-color: #3498db;
        }
        .main-content {
            padding: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            height: 400px;
        }
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-header">
                    <h3>Admin Panel</h3>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="users">
                            <i class="bi bi-people"></i> User Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="jobs">
                            <i class="bi bi-briefcase"></i> Jobs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="applications">
                            <i class="bi bi-file-text"></i> Applications
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link text-danger" href="#" id="logoutBtn">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="container-fluid">
                    <!-- Dashboard Section -->
                    <div class="section-content" id="dashboard-section">
                        <h2 class="mb-4">Dashboard Overview</h2>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="bi bi-person text-primary"></i>
                                    <h3 id="totalJobseekers">0</h3>
                                    <p>Total Jobseekers</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="bi bi-building text-success"></i>
                                    <h3 id="totalEmployers">0</h3>
                                    <p>Total Employers</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="bi bi-briefcase text-warning"></i>
                                    <h3 id="activeJobs">0</h3>
                                    <p>Active Jobs</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="bi bi-file-text text-info"></i>
                                    <h3 id="totalApplications">0</h3>
                                    <p>Total Applications</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4>Monthly Registrations</h4>
                                    <canvas id="registrationsChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <h4>Monthly Job Postings</h4>
                                    <canvas id="jobsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Section -->
                    <div class="section-content" id="users-section">
                        <h2 class="mb-4">User Management</h2>
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">User Reports</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="filterUsers()">
                                        <i class="bi bi-funnel"></i> Filter
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="exportUsersReport()">
                                        <i class="bi bi-download"></i> Export Report
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <select class="form-select" id="userTypeFilter">
                                            <option value="">All Users</option>
                                            <option value="jobseeker">Job Seekers</option>
                                            <option value="employer">Employers</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="userStatusFilter">
                                            <option value="">All Statuses</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="date" class="form-control" id="userDateFilter" placeholder="Joined Date">
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Type</th>
                                                <th>Location/Company</th>
                                                <th>Joined Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Jobs Section -->
                    <div class="section-content" id="jobs-section">
                        <h2 class="mb-4">Manage Jobs</h2>
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Job Reports</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="filterJobs()">
                                        <i class="bi bi-funnel"></i> Filter
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="exportJobsReport()">
                                        <i class="bi bi-download"></i> Export Report
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <select class="form-select" id="jobStatusFilter">
                                            <option value="">All Statuses</option>
                                            <option value="active">Active</option>
                                            <option value="closed">Closed</option>
                                            <option value="draft">Draft</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="date" class="form-control" id="jobDateFilter" placeholder="Posted Date">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="jobSearchFilter" placeholder="Search jobs...">
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Company</th>
                                                <th>Posted Date</th>
                                                <th>Applications</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="jobsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Applications Section -->
                    <div class="section-content" id="applications-section">
                        <h2 class="mb-4">Job Applications</h2>
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Application Reports</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="filterApplications()">
                                        <i class="bi bi-funnel"></i> Filter
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="exportApplicationsReport()">
                                        <i class="bi bi-download"></i> Export Report
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <select class="form-select" id="applicationStatusFilter">
                                            <option value="">All Statuses</option>
                                            <option value="pending">Pending</option>
                                            <option value="reviewed">Reviewed</option>
                                            <option value="shortlisted">Shortlisted</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="date" class="form-control" id="applicationDateFilter" placeholder="Applied Date">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" id="applicationSearchFilter" placeholder="Search applications...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="applicationJobFilter">
                                            <option value="">All Jobs</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Applicant</th>
                                                <th>Job Title</th>
                                                <th>Company</th>
                                                <th>Applied Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="applicationsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check admin authentication
        function checkAdminAuth() {
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                window.location.href = 'admin-login.html';
            }
        }

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                if (e.target.id === 'logoutBtn') {
                    logout();
                    return;
                }
                
                e.preventDefault();
                const section = e.target.dataset.section;
                
                // Update active link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Show selected section
                document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
                document.getElementById(`${section}-section`).style.display = 'block';
                
                // Load section data
                loadSectionData(section);
            });
        });

        // Load section data
        async function loadSectionData(section) {
            try {
                const adminToken = localStorage.getItem('adminToken');
                if (!adminToken) {
                    console.error('No admin token found');
                    return;
                }

                switch(section) {
                    case 'dashboard':
                        await loadDashboardStats();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'jobs':
                        await loadJobs();
                        break;
                    case 'applications':
                        await loadApplications();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${section} data:`, error);
                showAlert('error', `Error loading ${section} data. Please try again.`);
            }
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                if (!adminToken) {
                    console.error('No admin token found');
                    return;
                }

                // Fetch all statistics in parallel
                const [jobseekersRes, employersRes, jobsRes, applicationsRes, monthlyStatsRes] = await Promise.all([
                    fetch('http://localhost:3000/api/admin/stats/jobseekers', {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch('http://localhost:3000/api/admin/stats/employers', {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch('http://localhost:3000/api/admin/stats/jobs', {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch('http://localhost:3000/api/admin/stats/applications', {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch('http://localhost:3000/api/admin/stats/monthly', {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    })
                ]);

                // Check if any request failed
                if (!jobseekersRes.ok || !employersRes.ok || !jobsRes.ok || !applicationsRes.ok || !monthlyStatsRes.ok) {
                    throw new Error('One or more API requests failed');
                }

                // Parse responses
                const [jobseekersData, employersData, jobsData, applicationsData, monthlyStats] = await Promise.all([
                    jobseekersRes.json(),
                    employersRes.json(),
                    jobsRes.json(),
                    applicationsRes.json(),
                    monthlyStatsRes.json()
                ]);

                // Update dashboard statistics
                document.getElementById('totalJobseekers').textContent = jobseekersData.count || 'N/A';
                document.getElementById('totalEmployers').textContent = employersData.count || 'N/A';
                document.getElementById('activeJobs').textContent = jobsData.count || 'N/A';
                document.getElementById('totalApplications').textContent = applicationsData.count || 'N/A';

                // Update charts if data exists
                if (monthlyStats && monthlyStats.registrations) {
                    updateRegistrationsChart(monthlyStats.registrations);
                }
                if (monthlyStats && monthlyStats.jobPostings) {
                    updateJobsChart(monthlyStats.jobPostings);
                }

                // Load recent jobs
                const recentJobsRes = await fetch('http://localhost:3000/api/admin/jobs/recent', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (recentJobsRes.ok) {
                    const recentJobs = await recentJobsRes.json();
                    const recentJobsList = document.getElementById('recentJobsList');
                    if (recentJobsList) {
                        recentJobsList.innerHTML = recentJobs.map(job => `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${job.title}</h6>
                                    <small>${new Date(job.createdAt).toLocaleDateString()}</small>
                                </div>
                                <p class="mb-1">${job.company}</p>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Show error message to user
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger';
                errorMessage.textContent = 'Error loading dashboard data. Please try again.';
                document.querySelector('.container-fluid').prepend(errorMessage);
            }
        }

        // Load users (combined jobseekers and employers)
        async function loadUsers() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                let allUsers = [];

                // Fetch jobseekers
                const jobseekersResponse = await fetch('http://localhost:3000/api/admin/users/jobseekers', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (jobseekersResponse.ok) {
                    const jobseekers = await jobseekersResponse.json();
                    allUsers = allUsers.concat(jobseekers.map(user => ({
                        ...user,
                        type: 'Jobseeker',
                        displayName: `${user.firstName} ${user.lastName}`,
                        location: user.location || 'Not specified'
                    })));
                }

                // Fetch employers
                const employersResponse = await fetch('http://localhost:3000/api/admin/users/employers', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (employersResponse.ok) {
                    const employers = await employersResponse.json();
                    allUsers = allUsers.concat(employers.map(user => ({
                        ...user,
                        type: 'Employer',
                        displayName: user.companyName,
                        location: user.company || 'Not specified'
                    })));
                }

                // Sort users by joined date (newest first)
                allUsers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Update table
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                allUsers.forEach(user => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${user.displayName}</td>
                            <td>${user.email || user.companyEmail}</td>
                            <td><span class="badge ${user.type === 'Jobseeker' ? 'bg-primary' : 'bg-success'}">${user.type}</span></td>
                            <td>${user.location}</td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            <td>
                                <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                    ${user.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewUser('${user._id}', '${user.type}')">View</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}', '${user.type}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('error', 'Error loading users. Please try again.');
            }
        }

        // Filter users
        function filterUsers() {
            const userType = document.getElementById('userTypeFilter').value;
            const userStatus = document.getElementById('userStatusFilter').value;
            const userDate = document.getElementById('userDateFilter').value;

            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const type = row.querySelector('td:nth-child(3)').textContent.trim();
                const status = row.querySelector('td:nth-child(6)').textContent.trim();
                const date = row.querySelector('td:nth-child(5)').textContent;

                const typeMatch = !userType || type === userType;
                const statusMatch = !userStatus || status === userStatus;
                const dateMatch = !userDate || date === new Date(userDate).toLocaleDateString();

                row.style.display = typeMatch && statusMatch && dateMatch ? '' : 'none';
            });
        }

        // Export users report
        async function exportUsersReport() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                const response = await fetch('http://localhost:3000/api/admin/reports/users', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `users-report-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Failed to generate report');
                }
            } catch (error) {
                console.error('Error exporting users report:', error);
                showAlert('error', 'Error generating report. Please try again.');
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                const status = document.getElementById('jobStatusFilter').value;
                const date = document.getElementById('jobDateFilter').value;
                const search = document.getElementById('jobSearchFilter').value;

                const response = await fetch(`http://localhost:3000/api/admin/jobs?status=${status}&date=${date}&search=${search}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const jobs = await response.json();
                    const tbody = document.getElementById('jobsTableBody');
                    tbody.innerHTML = '';
                    
                    jobs.forEach(job => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${job.title}</td>
                                <td>${job.company}</td>
                                <td>${new Date(job.postedDate).toLocaleDateString()}</td>
                                <td>${job.applications}</td>
                                <td>${job.status}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editJob('${job._id}')">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteJob('${job._id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                showAlert('error', 'Error loading jobs. Please try again.');
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                const status = document.getElementById('applicationStatusFilter').value;
                const date = document.getElementById('applicationDateFilter').value;
                const search = document.getElementById('applicationSearchFilter').value;
                const job = document.getElementById('applicationJobFilter').value;

                const response = await fetch(`http://localhost:3000/api/admin/applications?status=${status}&date=${date}&search=${search}&job=${job}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const applications = await response.json();
                    const tbody = document.getElementById('applicationsTableBody');
                    tbody.innerHTML = '';
                    
                    applications.forEach(app => {
                        tbody.innerHTML += `
                            <tr data-job-id="${app.jobId}">
                                <td>${app.applicantName}</td>
                                <td>${app.jobTitle}</td>
                                <td>${app.company}</td>
                                <td>${new Date(app.appliedDate).toLocaleDateString()}</td>
                                <td>${app.status}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewApplication('${app._id}')">View</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Update job filter options
                    const jobFilter = document.getElementById('applicationJobFilter');
                    const uniqueJobs = [...new Set(applications.map(app => app.jobId))];
                    jobFilter.innerHTML = '<option value="">All Jobs</option>';
                    uniqueJobs.forEach(jobId => {
                        const job = applications.find(app => app.jobId === jobId);
                        jobFilter.innerHTML += `<option value="${jobId}">${job.jobTitle}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                showAlert('error', 'Error loading applications. Please try again.');
            }
        }

        // Chart update functions
        function updateRegistrationsChart(data) {
            const ctx = document.getElementById('registrationsChart');
            if (!ctx) {
                console.error('Registrations chart canvas not found');
                return;
            }

            try {
                // Destroy existing chart if it exists and is a Chart instance
                if (window.registrationsChart instanceof Chart) {
                    window.registrationsChart.destroy();
                }

                // Prepare data
                const months = data.map(item => {
                    const date = new Date(item.month);
                    return date.toLocaleString('default', { month: 'short', year: 'numeric' });
                });
                const jobseekers = data.map(item => item.jobseekers || 0);
                const employers = data.map(item => item.employers || 0);

                // Create new chart
                window.registrationsChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Jobseekers',
                                data: jobseekers,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Employers',
                                data: employers,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating registrations chart:', error);
            }
        }

        function updateJobsChart(data) {
            const ctx = document.getElementById('jobsChart');
            if (!ctx) {
                console.error('Jobs chart canvas not found');
                return;
            }

            try {
                // Destroy existing chart if it exists and is a Chart instance
                if (window.jobsChart instanceof Chart) {
                    window.jobsChart.destroy();
                }

                // Prepare data
                const months = data.map(item => {
                    const date = new Date(item.month);
                    return date.toLocaleString('default', { month: 'short', year: 'numeric' });
                });
                const jobCounts = data.map(item => item.count || 0);

                // Create new chart
                window.jobsChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Job Postings',
                                data: jobCounts,
                                backgroundColor: 'rgba(255, 206, 86, 0.5)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating jobs chart:', error);
            }
        }

        // Filter jobs
        function filterJobs() {
            const status = document.getElementById('jobStatusFilter').value;
            const date = document.getElementById('jobDateFilter').value;
            const search = document.getElementById('jobSearchFilter').value.toLowerCase();

            const rows = document.querySelectorAll('#jobsTableBody tr');
            rows.forEach(row => {
                const jobStatus = row.querySelector('td:nth-child(5)').textContent.trim();
                const jobDate = row.querySelector('td:nth-child(3)').textContent;
                const jobTitle = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const company = row.querySelector('td:nth-child(2)').textContent.toLowerCase();

                const statusMatch = !status || jobStatus === status;
                const dateMatch = !date || jobDate === new Date(date).toLocaleDateString();
                const searchMatch = !search || jobTitle.includes(search) || company.includes(search);

                row.style.display = statusMatch && dateMatch && searchMatch ? '' : 'none';
            });
        }

        // Export jobs report
        async function exportJobsReport() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                const status = document.getElementById('jobStatusFilter').value;
                const date = document.getElementById('jobDateFilter').value;
                const search = document.getElementById('jobSearchFilter').value;

                const response = await fetch(`http://localhost:3000/api/admin/reports/jobs?status=${status}&date=${date}&search=${search}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `jobs-report-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Failed to generate report');
                }
            } catch (error) {
                console.error('Error exporting jobs report:', error);
                showAlert('error', 'Error generating report. Please try again.');
            }
        }

        // Filter applications
        function filterApplications() {
            const status = document.getElementById('applicationStatusFilter').value;
            const date = document.getElementById('applicationDateFilter').value;
            const search = document.getElementById('applicationSearchFilter').value.toLowerCase();
            const job = document.getElementById('applicationJobFilter').value;

            const rows = document.querySelectorAll('#applicationsTableBody tr');
            rows.forEach(row => {
                const applicationStatus = row.querySelector('td:nth-child(5)').textContent.trim();
                const applicationDate = row.querySelector('td:nth-child(4)').textContent;
                const applicantName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const jobId = row.getAttribute('data-job-id');

                const statusMatch = !status || applicationStatus === status;
                const dateMatch = !date || applicationDate === new Date(date).toLocaleDateString();
                const searchMatch = !search || applicantName.includes(search);
                const jobMatch = !job || jobId === job;

                row.style.display = statusMatch && dateMatch && searchMatch && jobMatch ? '' : 'none';
            });
        }

        // Export applications report
        async function exportApplicationsReport() {
            try {
                const adminToken = localStorage.getItem('adminToken');
                const status = document.getElementById('applicationStatusFilter').value;
                const date = document.getElementById('applicationDateFilter').value;
                const search = document.getElementById('applicationSearchFilter').value;
                const job = document.getElementById('applicationJobFilter').value;

                const response = await fetch(`http://localhost:3000/api/admin/reports/applications?status=${status}&date=${date}&search=${search}&job=${job}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `applications-report-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Failed to generate report');
                }
            } catch (error) {
                console.error('Error exporting applications report:', error);
                showAlert('error', 'Error generating report. Please try again.');
            }
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            // Job filters
            document.getElementById('jobStatusFilter').addEventListener('change', filterJobs);
            document.getElementById('jobDateFilter').addEventListener('change', filterJobs);
            document.getElementById('jobSearchFilter').addEventListener('input', filterJobs);

            // Application filters
            document.getElementById('applicationStatusFilter').addEventListener('change', filterApplications);
            document.getElementById('applicationDateFilter').addEventListener('change', filterApplications);
            document.getElementById('applicationSearchFilter').addEventListener('input', filterApplications);
            document.getElementById('applicationJobFilter').addEventListener('change', filterApplications);
        });

        // Logout function
        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminId');
            window.location.href = 'admin-login.html';
        }

        // Initialize dashboard
        checkAdminAuth();
        loadDashboardStats();
    </script>
</body>
</html> 